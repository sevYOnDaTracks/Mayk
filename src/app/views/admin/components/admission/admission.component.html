<div class="container mt-5" *ngIf="user$ | async as user; else loading">
    <div align="center"> <h1> Admissions  <mat-icon>school</mat-icon></h1> </div>
    <div align="center" class="mt-5"><h3>Choisissez le pays souhaitez pour démarrer le formulaire ! </h3> </div>
    <br>
    <div class="row justify-content-center">
        <div class="col-lg-12 col-md-12">
            <mat-card class="">
                <mat-card-title class="text-center mb-4 mt-3"></mat-card-title>
                <mat-card-content>
                    <form [formGroup]="educationForm">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Pays</mat-label>
                            <mat-select formControlName="country" (selectionChange)="onCountryChange($event.value)">
                                <mat-option *ngFor="let country of countries" [value]="country.value">{{ country.viewValue }}</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-vertical-stepper linear>
                            <mat-step *ngIf="selectedCountry" [stepControl]="educationForm.get('admissionType')">
                                <ng-template matStepLabel>Type d'Admission ({{ selectedAdmissionType || 'Sélectionnez' }})</ng-template>
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-select formControlName="admissionType" (selectionChange)="onAdmissionTypeChange($event.value)">
                                        <mat-option *ngFor="let type of admissionTypes" [value]="type.value">{{ type.viewValue }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="primary" matStepperNext>Suivant</button>
                                </div>
                            </mat-step>

                            <mat-step *ngIf="selectedAdmissionType && selectedCountry" [stepControl]="educationForm.get('fieldOfStudy')">
                                <ng-template matStepLabel>Filière ({{ selectedField || 'Sélectionnez' }})</ng-template>
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-select formControlName="fieldOfStudy" (selectionChange)="onFieldOfStudyChange($event.value)">
                                        <mat-option *ngFor="let field of fieldsOfStudy" [value]="field.value">{{ field.viewValue }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="accent" matStepperPrevious>Revenir</button>
                                    <button mat-raised-button color="primary" matStepperNext>Suivant</button>
                                </div>
                            </mat-step>


                            <mat-step *ngIf="selectedAdmissionType && selectedCountry" [stepControl]="educationForm.get('educationLevel')">
                                <ng-template matStepLabel>Niveau d'étude actuel ({{ selectedLevel || 'Sélectionnez' }})</ng-template>
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-select formControlName="educationLevel" (selectionChange)="onEducationLevelChange($event.value)">
                                        <mat-option *ngFor="let level of educationLevels" [value]="level.value">{{ level.viewValue }}</mat-option>
                                    </mat-select>
                                    <mat-hint>Votre niveau d'étude actuel</mat-hint>
                                </mat-form-field>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="accent" matStepperPrevious>Revenir</button>
                                    <button mat-raised-button color="primary" matStepperNext>Suivant</button>
                                </div>
                            </mat-step>

                            <!-- PARCOURS SUP -->

                            <mat-step *ngIf="selectedAdmissionType === 'PARCOURS_SUP' || selectedAdmissionType === 'ECOLE_PRIVEE' || selectedAdmissionType === 'ETUDE_UNIVERSITAIRE' || selectedAdmissionType === 'CEGEP_COLLEGIALE' && selectedLevel">
                                <ng-template matStepLabel>Baccalauréat & bulletin de notes</ng-template>
                                <mat-card class="p-4 mt-5">
                                    <div align="center">
                                        <h3>Étude Secondaire</h3>
                                        <mat-icon>school</mat-icon>
                                    </div>
                                    <div align="center" class="mt-2">
                                        <p>Ici il est question de renseigner vos moyennes obtenu par trimestre durant votre cursus secondaire et d'y joindre les justificatifs respectifs !</p>
                                    </div>
                                    <div *ngFor="let year of ['2nd', 'Première', 'Terminale']">
                                        <div align="center" class="mt-3 mb-4" style="background-color:rgba(216,216,216,0.31); border-radius: 10px">
                                            <h4> {{ year }}</h4>
                                        </div>
                                        <div *ngFor="let term of [1, 2, 3]" class="row">
                                            <div class="col-lg-6 col-md-6 col-sm-12 justificatif-btn">
                                                <button mat-raised-button color="primary" (click)="fileInput.click()">Justificatif <mat-icon>add</mat-icon></button>
                                                <input type="file" #fileInput hidden (change)="onFileSelected($event, year + term)">
                                                <span *ngIf="fileNames[year + term]">{{ fileNames[year + term] }}</span>
                                            </div>
                                            <mat-form-field appearance="outline" floatLabel="always" class="col-lg-6 col-md-6 col-sm-12">
                                                <mat-label>Moyenne Trimestre {{ term }}</mat-label>
                                                <input matInput [formControlName]="'termAverage' + year + term">
                                                <mat-hint>Moyenne du Trimestre {{term}} obtenu /20</mat-hint>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </mat-card>
                                <mat-card class="p-4 mt-3">
                                    <div align="center">
                                        <h3>Baccalauréat</h3>
                                    </div>
                                    <div align="center" class="mt-2">
                                        <p>Ici il est question de choisir le type d'enseignement, joindre votre collante puis de renseigner le nombre de points obtenu au bac !</p>
                                    </div>
                                    <div class="row mt-2">
                                        <mat-radio-group aria-label="Select an option">
                                            <mat-radio-button value="1">BAC Général</mat-radio-button>
                                            <mat-radio-button value="2">BAC Technique</mat-radio-button>
                                        </mat-radio-group>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-6 col-md-6 col-sm-12 justificatif-btn">
                                            <button mat-raised-button color="primary" (click)="bacFileInput.click()">Justificatif<mat-icon>add</mat-icon></button>
                                            <input type="file" #bacFileInput hidden (change)="onBacFileSelected($event)">
                                            <span *ngIf="bacFileName">{{ bacFileName }}</span>
                                        </div>
                                        <mat-form-field appearance="outline" floatLabel="always" class="col-lg-6 col-md-6 col-sm-12">
                                            <mat-label>Moyenne générale</mat-label>
                                            <input matInput formControlName="bacAverage">
                                            <mat-hint>Mettre le nombre de points obtenu</mat-hint>
                                        </mat-form-field>
                                    </div>
                                </mat-card>
                                <mat-card class="p-4 mt-3">
                                    <div align="center">
                                        <h3>Étude Supérieure</h3>
                                    </div>
                                    <div align="center">
                                        <p>Ici il est question de renseigner vos moyennes ainsi que d'y joindre vos bulletin respectifs par année d'étude !</p>
                                    </div>
                                    <div *ngFor="let year of getYears(selectedLevel)">
                                        <div align="center" class="mb-3" style="background-color: rgba(216,216,216,0.31); border-radius: 10px">
                                            <h4>Année {{ year }} <mat-icon>school</mat-icon></h4>
                                        </div>
                                        <div *ngFor="let semester of [1, 2]" class="row">
                                            <div class="col-lg-6 col-md-6 col-sm-12 justificatif-btn">
                                                <button mat-raised-button color="primary" (click)="fileInput.click()">Justificatif <mat-icon>add</mat-icon></button>
                                                <input type="file" #fileInput hidden (change)="onFileSelected($event, 'year' + year + 'semester' + semester)">
                                                <span *ngIf="fileNames['year' + year + 'semester' + semester]">{{ fileNames['year' + year + 'semester' + semester] }}</span>
                                            </div>
                                            <mat-form-field appearance="outline" floatLabel="always" class="col-lg-6 col-md-6 col-sm-12">
                                                <mat-label>Moyenne Semestre {{ semester }} </mat-label>
                                                <input matInput [formControlName]="'averageYear' + year + 'Sem' + semester">
                                                <mat-hint>Moyenne du semestre {{semester}} obtenu /20</mat-hint>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </mat-card>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="accent" matStepperPrevious>Précédent</button>
                                    <button mat-raised-button color="primary" matStepperNext>Suivant</button>
                                </div>
                            </mat-step>

                            <!-- CAMPUS FRANCE -->
                            <mat-step *ngIf="selectedAdmissionType === 'CAMPUS_FRANCE' && selectedLevel">
                                <ng-template matStepLabel>Baccalauréat & bulletin de notes</ng-template>
                                <mat-card class="p-4 mt-5">
                                    <div align="center">
                                        <h3>Baccalauréat</h3>
                                    </div>
                                    <div align="center" class="mt-2">
                                        <p>Ici il est question de choisir le type d'enseignement, joindre votre collante puis de renseigner le nombre de points obtenu au bac !</p>
                                    </div>
                                    <div class="row mt-2">
                                        <mat-radio-group aria-label="Select an option">
                                            <mat-radio-button value="1">BAC Général</mat-radio-button>
                                            <mat-radio-button value="2">BAC Technique</mat-radio-button>
                                        </mat-radio-group>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-6 col-md-6 col-sm-12 justificatif-btn">
                                            <button mat-raised-button color="primary" (click)="campusFranceFileInput.click()">Justificatif <mat-icon>add</mat-icon></button>
                                            <input type="file" #campusFranceFileInput hidden (change)="onCampusFranceFileSelected($event)">
                                            <span *ngIf="campusFranceFileName" class="file-name">{{ campusFranceFileName }}</span>
                                            <br>
                                        </div>
                                        <mat-form-field appearance="outline" floatLabel="always" class="col-lg-6 col-md-6 col-sm-12">
                                            <mat-label>Nombre de point </mat-label>
                                            <input matInput type="number" formControlName="bacAverage">
                                            <mat-hint>Mettre le nombre de points obtenu</mat-hint>
                                        </mat-form-field>
                                    </div>
                                </mat-card>
                                <mat-card class="p-4 mt-3">
                                    <div align="center">
                                        <h3>Étude Supérieure</h3>
                                    </div>
                                    <div align="center">
                                        <p>Ici il est question de renseigner vos moyennes ainsi que d'y joindre vos bulletin respectifs par année d'étude !</p>
                                    </div>
                                    <div *ngFor="let year of getYears(selectedLevel)">
                                        <div align="center" class="mb-3" style="background-color: rgba(216,216,216,0.31); border-radius: 10px">
                                            <h4>Année {{ year }} <mat-icon>school</mat-icon></h4>
                                        </div>
                                        <div *ngFor="let semester of [1, 2]" class="row">
                                            <div class="col-lg-6 col-md-6 col-sm-12 justificatif-btn">
                                                <button mat-raised-button color="primary" (click)="fileInput.click()">Justificatif <mat-icon>add</mat-icon></button>
                                                <input type="file" #fileInput hidden (change)="onFileSelected($event, 'year' + year + 'semester' + semester)">
                                                <span *ngIf="fileNames['year' + year + 'semester' + semester]" class="file-name">{{ fileNames['year' + year + 'semester' + semester] }}</span>
                                            </div>
                                            <mat-form-field appearance="outline" floatLabel="always" class="col-lg-6 col-md-6 col-sm-12">
                                                <mat-label>Moyenne Semestre {{ semester }}</mat-label>
                                                <input matInput type="number" [formControlName]="'averageYear' + year + 'Sem' + semester">
                                                <mat-hint>Moyenne du semestre {{semester}} obtenu /20</mat-hint>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </mat-card>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="accent" matStepperPrevious>Revenir</button>
                                    <button mat-raised-button color="primary" matStepperNext>Suivant</button>
                                </div>
                            </mat-step>

                            <!-- Commentaire et message particulier Relatif à votre candidature -->
                            <mat-step *ngIf="selectedLevel" [stepControl]="educationForm.get('comments')">
                                <ng-template matStepLabel>Commentaire et message particulier Relatif à votre demande</ng-template>
                                <mat-form-field appearance="outline" floatLabel="always" class="full-width">
                                    <textarea matInput formControlName="comments" rows="5"></textarea>
                                    <mat-hint>Vous pouvez nous laisser des consignes</mat-hint>
                                </mat-form-field>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="accent" matStepperPrevious>Revenir</button>
                                    <button mat-raised-button color="primary" matStepperNext>Suivant</button>
                                </div>
                            </mat-step>

                            <!-- Récapitulatif -->
                            <mat-step *ngIf="educationForm.valid">
                                <ng-template matStepLabel>Récapitulatif</ng-template>
                                <mat-card class="p-4">
                                    <h3 align="center">Récapitulatif </h3>
                                    <div class="summary">
                                        <p><strong>Pays:</strong> {{ selectedCountry }}</p>
                                        <p><strong>Admission:</strong> {{ selectedAdmissionType }}</p>
                                        <p><strong>Filière :</strong>{{ educationForm.get('fieldOfStudy').value }} </p>
                                        <p><strong>Niveau actuel :</strong> {{ selectedLevel }}</p>
                                        <!-- Ajoutez d'autres champs ici selon les besoins -->
                                    </div>
                                </mat-card>
                                <div class="stepper-buttons">
                                    <button mat-raised-button color="accent" matStepperPrevious>Précédent</button>
                                    <button mat-raised-button color="primary" (click)="submitForm()">Soumettre</button>
                                </div>
                            </mat-step>
                        </mat-vertical-stepper>
                    </form>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</div>

<ng-template #loading>
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <mat-spinner diameter="50"></mat-spinner>
    </div>
</ng-template>
